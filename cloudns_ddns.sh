#!/bin/bash

# =================================================================
# ClouDNS Daily Auto-Updater (UTC+8)
# ä¸€éµè¨­å®š ClouDNS æ¯æ—¥å®šæ™‚æ›´æ–°è…³æœ¬
#
# åŠŸèƒ½ï¼š
# 1. è‡ªå‹•æ ¡æ­£ç³»çµ±æ™‚å€ç‚º Asia/Taipei (UTC+8)
# 2. äº’å‹•å¼è¼¸å…¥ ClouDNS Dynamic URL
# 3. æŒ‡å®šæ¯æ—¥åŸ·è¡Œæ™‚é–“ (HH:MM)
# 4. è‡ªå‹•è¨­å®š Crontab æ’ç¨‹
# =================================================================

# --- é¡è‰²å®šç¾© ---
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

clear
echo -e "${GREEN}#################################################${NC}"
echo -e "${GREEN}#      ClouDNS DDNS æ¯æ—¥å®šæ™‚ä»»å‹™è¨­å®šç²¾éˆ        #${NC}"
echo -e "${GREEN}#     (Daily Update / UTC+8 Timezone Support)   #${NC}"
echo -e "${GREEN}#################################################${NC}"

# 1. æª¢æŸ¥ Root æ¬Šé™
if [ "$EUID" -ne 0 ]; then
  echo -e "${RED}[Error] è«‹ä½¿ç”¨ root æ¬Šé™åŸ·è¡Œæ­¤è…³æœ¬ (sudo -i)${NC}"
  exit 1
fi

# 2. è¨­å®šæ™‚å€ (ç¢ºä¿æ˜¯æ±å…«å€ UTC+8)
echo -e "\n${CYAN}>>> æ­£åœ¨æ ¡æ­£ç³»çµ±æ™‚å€ç‚º æ±å…«å€ (Asia/Taipei)...${NC}"
if command -v timedatectl &> /dev/null; then
    timedatectl set-timezone Asia/Taipei
else
    ln -sf /usr/share/zoneinfo/Asia/Taipei /etc/localtime
fi
echo -e "âœ… ç•¶å‰ç³»çµ±æ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S')"

# 3. æ­¥é©Ÿä¸€ï¼šè©¢å• DDNS é‡‘é‘° (URL)
echo -e "\n${YELLOW}ã€æ­¥é©Ÿ 1ã€‘è¨­å®š DDNS é‡‘é‘°${NC}"
echo "è«‹è¼¸å…¥æ‚¨çš„ ClouDNS Dynamic URL (ä¾‹å¦‚: https://ipv4.cloudns.net/...)"
read -p "URL: " DDNS_URL

if [[ -z "$DDNS_URL" ]]; then
    echo -e "${RED}[Error] URL ä¸èƒ½ç‚ºç©ºï¼${NC}"
    exit 1
fi

# 4. æ­¥é©ŸäºŒï¼šè©¢å•æ¯æ—¥åŸ·è¡Œæ™‚é–“
echo -e "\n${YELLOW}ã€æ­¥é©Ÿ 2ã€‘è¨­å®šæ¯å¤©å•Ÿå‹•æ™‚é–“ (24å°æ™‚åˆ¶)${NC}"
read -p "è«‹å•è¦æ¯å¤©å¹¾é»åŸ·è¡Œ? (è¼¸å…¥ 0-23): " RUN_HOUR
read -p "è«‹å•è¦å¹¾åˆ†åŸ·è¡Œ? (è¼¸å…¥ 0-59): " RUN_MINUTE

if ! [[ "$RUN_HOUR" =~ ^[0-9]+$ ]] || ! [[ "$RUN_MINUTE" =~ ^[0-9]+$ ]]; then
    echo -e "${RED}[Error] æ™‚é–“æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥æ•¸å­—ï¼${NC}"
    exit 1
fi

# 5. æ­¥é©Ÿä¸‰ï¼šéƒ¨ç½²è…³æœ¬
echo -e "\n${CYAN}>>> æ­£åœ¨éƒ¨ç½²è‡ªå‹•åŒ–è…³æœ¬...${NC}"

TARGET_SCRIPT="/usr/local/bin/cloudns_daily_update.sh"
LOG_FILE="/var/log/cloudns_ddns.log"

# å»ºç«‹å¯¦éš›åŸ·è¡Œçš„è…³æœ¬
cat > "$TARGET_SCRIPT" <<ENDSCRIPT
#!/bin/bash
# Auto-generated by setup script
# Run Time: Daily at $RUN_HOUR:$RUN_MINUTE

NOW=\$(date '+%Y-%m-%d %H:%M:%S')
RESPONSE=\$(curl -s -w "%{http_code}" "$DDNS_URL")

if [[ "\$RESPONSE" == *"200"* ]]; then
    echo "\$NOW [SUCCESS] DDNS Updated (HTTP 200)" >> $LOG_FILE
else
    echo "\$NOW [FAIL] DDNS Update Error (HTTP \$RESPONSE)" >> $LOG_FILE
fi

# Log Rotation (Keep last 50 lines)
tail -n 50 $LOG_FILE > ${LOG_FILE}.tmp && mv ${LOG_FILE}.tmp $LOG_FILE
ENDSCRIPT

chmod +x "$TARGET_SCRIPT"

# 6. è¨­å®š Crontab
CRON_CMD="$RUN_MINUTE $RUN_HOUR * * * $TARGET_SCRIPT"
(crontab -l 2>/dev/null | grep -v "cloudns_daily_update.sh"; echo "$CRON_CMD") | crontab -

echo -e "\n${GREEN}ğŸ‰ è¨­å®šå®Œæˆ (Setup Complete)ï¼${NC}"
echo -e "----------------------------------------------------"
echo -e "ğŸ“… é »ç‡ (Freq): æ¯å¤© (Daily)"
echo -e "â° æ™‚é–“ (Time): ${YELLOW}${RUN_HOUR}:${RUN_MINUTE}${NC} (Asia/Taipei)"
echo -e "ğŸ“„ è…³æœ¬ (Script): $TARGET_SCRIPT"
echo -e "ğŸ“ æ—¥èªŒ (Log): $LOG_FILE"
echo -e "----------------------------------------------------"

echo -e "\næ­£åœ¨åŸ·è¡Œé€£ç·šæ¸¬è©¦..."
$TARGET_SCRIPT
echo -e "æ¸¬è©¦çµæŸï¼Œè«‹æª¢æŸ¥æ—¥èªŒã€‚"
